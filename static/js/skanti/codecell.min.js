var skanti=(function(c){var b=c.utils;var a=function(d){this.code_mirror=null;this.input_prompt_number="&nbsp;";this.is_completing=false;this.completion_cursor=null;this.outputs=[];this.collapsed=false;this.tooltip_timeout=null;c.Cell.apply(this,arguments)};a.prototype=new c.Cell();a.prototype.create_element=function(){var d=$("<div></div>").addClass("cell border-box-sizing code_cell vbox");d.attr("tabindex","2");var g=$("<div></div>").addClass("input hbox");g.append($("<div/>").addClass("prompt input_prompt"));var f=$("<div/>").addClass("input_area box-flex1");this.code_mirror=CodeMirror(f.get(0),{indentUnit:4,mode:"javascript",theme:"ipython",readOnly:this.read_only,onKeyEvent:$.proxy(this.handle_codemirror_keyevent,this)});g.append(f);var e=$("<div></div>").addClass("output vbox");d.append(g).append(e);this.element=d;this.collapse()};a.prototype.request_tooltip_after_time=function(d,f){var e=this;if(d===""||d==="("){}else{e.tooltip_timeout=setTimeout(function(){},f)}};a.prototype.handle_codemirror_keyevent=function(h,d){if(this.read_only){return false}tooltip_wait_time=this.notebook.time_before_tooltip;tooltip_on_tab=this.notebook.tooltip_on_tab;var g=this;if(d.type==="keydown"){g.remove_and_cancel_tooltip()}if(d.keyCode===13&&(d.shiftKey||d.ctrlKey)){return true}else{if(d.which===40&&d.type==="keypress"&&tooltip_wait_time>=0){var l=h.getCursor();var i=h.getRange({line:l.line,ch:0},l).trim()+"(";g.request_tooltip_after_time(i,tooltip_wait_time)}else{if(d.keyCode===9&&d.type=="keydown"){var k=h.getCursor();var i=h.getRange({line:k.line,ch:0},k);if(i.trim()===""){return false}else{if((i.substr(-1)==="("||i.substr(-1)===" ")&&tooltip_on_tab){g.request_tooltip_after_time(i,0)}else{i.trim();d.stop();var m=h.getLine(k.line);this.is_completing=true;this.completion_cursor=k;c.notebook.complete_cell(this,m,k.ch);return true}}}else{if(d.keyCode===8&&d.type=="keydown"){var k=h.getCursor();var m=h.getLine(k.line);var f=m.slice(-4);if(f==="    "){h.replaceRange("",{line:k.line,ch:k.ch-4},{line:k.line,ch:k.ch});d.stop();return true}else{return false}}else{if(d.keyCode===76&&d.ctrlKey&&d.shiftKey&&d.type=="keydown"){this.toggle_line_numbers()}else{if(this.is_completing&&d.keyCode!==9){var e=h.getCursor();var j=this.completion_cursor;if(e.line!==j.line||e.ch!==j.ch){this.is_completing=false;this.completion_cursor=null}}return false}}}}}return false};a.prototype.remove_and_cancel_tooltip=function(){if(this.tooltip_timeout!=null){clearTimeout(this.tooltip_timeout);$("#tooltip").remove();this.tooltip_timeout=null}};a.prototype.finish_tooltip=function(d){defstring=d.call_def;if(defstring==null){defstring=d.init_definition}if(defstring==null){defstring=d.definition}docstring=d.call_docstring;if(docstring==null){docstring=d.init_docstring}if(docstring==null){docstring=d.docstring}if(docstring==null){docstring="<empty docstring>"}name=d.name;var g=this;var n=$("<div/>").attr("id","tooltip").addClass("tooltip");n.addClass("smalltooltip");var e=$("<pre/>").html(b.fixConsole(docstring));var j=$("<a/>").attr("href","#");j.addClass("ui-corner-all");j.attr("role","button");var l=$("<span/>").text("Expand");l.addClass("ui-icon");l.addClass("ui-icon-plus");j.append(l);j.attr("id","expanbutton");j.click(function(){n.removeClass("smalltooltip");n.addClass("bigtooltip");$("#expanbutton").remove();setTimeout(function(){g.code_mirror.focus()},50)});var f=$("<a/>").attr("href","#");f.attr("role","button");f.addClass("ui-button");var h=$("<span/>").text("Open in Pager");h.addClass("ui-icon");h.addClass("ui-icon-arrowstop-l-n");f.append(h);f.click(function(){});var k=$("<a/>").attr("href","#");k.attr("role","button");k.addClass("ui-button");var m=$("<span/>").text("Close");m.addClass("ui-icon");m.addClass("ui-icon-close");k.append(m);k.click(function(){g.remove_and_cancel_tooltip();setTimeout(function(){g.code_mirror.focus()},50)});n.append(k);n.append(j);n.append(f);if(defstring){defstring_html=$("<pre/>").html(b.fixConsole(defstring));n.append(defstring_html)}n.append(e);var i=this.code_mirror.cursorCoords();n.css("left",i.x+"px");n.css("top",i.yBot+"px");$("body").append(n)};a.prototype.finish_completing=function(k,e){if(!this.is_completing||e.length===0){return}var v={tab:9,esc:27,backspace:8,space:32,shift:16,enter:13,isCompSymbol:function(i){return(i>64&&i<=90)||(i>=97&&i<=122)||(i==95)},dismissAndAppend:function(i){chararr="()[]+-/\\. ,=*".split("");codearr=chararr.map(function(w){return w.charCodeAt(0)});return jQuery.inArray(i,codearr)!=-1}};var n=new Array();if(this.notebook.smart_completer){kwargs=new Array();other=new Array();for(var s=0;s<e.length;++s){if(e[s].substr(-1)==="="){kwargs.push(e[s])}else{other.push(e[s])}}n=kwargs.concat(other);e=n}function u(i){if(i.length==1){return i[0]}if(i.length>1){var y,x,w,i=i.slice(0).sort();y=i[0];w=y.length;x=i.pop();while(w&&x.indexOf(y)==-1){y=y.substring(0,--w)}return y}return""}fallback_on_tooltip_after=2;if(e.length==1&&k===e[0]){if(this.npressed>fallback_on_tooltip_after&&this.prevmatch==k){console.log("Ok, you really want to complete after pressing tab "+this.npressed+" times !");console.log("You should understand that there is no (more) completion for that !");console.log("I'll show you the tooltip, will you stop bothering me ?");this.request_tooltip_after_time(k+"(",0);return}this.prevmatch=k;this.npressed=this.npressed+1}else{this.prevmatch="";this.npressed=0}var l=this;var f=this.completion_cursor;var q=false;var p=function(){if(q){return}q=true;if(o!=undefined){o.remove()}l.is_completing=false;l.completion_cursor=null};prev=k;var m=function(i,w){l.code_mirror.replaceRange(i,{line:f.line,ch:(f.ch-k.length)},{line:f.line,ch:(f.ch+prev.length-k.length)});prev=i;if(w!=null){w.stopPropagation();w.preventDefault()}};var d=function(w,i){m(w);p();setTimeout(function(){l.code_mirror.focus()},50)};var g=function(){d(r.val()[0],null)};var h=function(z,A,x,y){if(z.length<1){d(A,y);if(y!=null){y.stopPropagation();y.preventDefault()}}else{if(x&&z.length==1){d(z[0],y);if(y!=null){y.stopPropagation();y.preventDefault()}}}m(A,y);o.children().children().remove();$("#asyoutype").html("<b>"+k+"</b>"+A.substr(k.length));r=$("#asyoutypeselect");for(var w=0;w<z.length;++w){r.append($("<option/>").html(z[w]))}r.children().first().attr("selected","true")};var o=$("<div/>").addClass("completions");o.attr("id","complete");o.append($("<p/>").attr("id","asyoutype").html("<b>fixed part</b>user part"));var r=$("<select/>").attr("multiple","true");r.attr("id","asyoutypeselect");r.attr("size",Math.min(10,e.length));var j=this.code_mirror.cursorCoords();o.css("left",j.x+"px");o.css("top",j.yBot+"px");o.append(r);$("body").append(o);fastForward=u(e);typed_characters=fastForward.substr(k.length);h(e,k+typed_characters,true,null);filterd=e;var t=function(z,i){var y=z.which;var w=false;if(i===0){press=true;down=false}else{if(i==1){press=false;down=true}}if(y===v.shift){return}if(v.dismissAndAppend(y)&&press){var x=String.fromCharCode(y);typed_characters=typed_characters+x;d(k+typed_characters,z);return}if(y===v.enter){z.stopPropagation();z.preventDefault();g()}else{if(y===38||y===40){z.stopPropagation()}else{if((y==v.backspace)||(y==v.tab&&down)||press||v.isCompSymbol(y)){if(v.isCompSymbol(y)&&press){var x=String.fromCharCode(y);typed_characters=typed_characters+x}else{if(y==v.tab){fastForward=u(filterd);ffsub=fastForward.substr(k.length+typed_characters.length);typed_characters=typed_characters+ffsub;w=true}else{if(y==v.backspace&&down){z.preventDefault();if(typed_characters.length<=0){d(k,z);return}typed_characters=typed_characters.substr(0,typed_characters.length-1)}else{if(press&&y!=v.backspace&&y!=v.tab&&y!=0){d(k+typed_characters,z);return}else{return}}}}re=new RegExp("^%?"+k+typed_characters,"");filterd=e.filter(function(A){return re.test(A)});h(filterd,k+typed_characters,w,z)}else{if(y==v.esc){d(k,z)}else{if(press){console.log("aborting with keycode : "+y+" is down :"+down)}}}}}};r.keydown(function(i){t(i,1)});r.keypress(function(i){t(i,0)});r.dblclick(g);r.blur(p);r.focus()};a.prototype.toggle_line_numbers=function(){if(this.code_mirror.getOption("lineNumbers")==false){this.code_mirror.setOption("lineNumbers",true)}else{this.code_mirror.setOption("lineNumbers",false)}this.code_mirror.refresh()};a.prototype.select=function(){c.Cell.prototype.select.apply(this);var d=this.code_mirror.getValue();this.code_mirror.focus();if(d===""){this.code_mirror.setValue("")}};a.prototype.select_all=function(){var g={line:0,ch:0};var f=this.code_mirror.lineCount();var d=this.code_mirror.getLine(f-1);var e={line:f-1,ch:d.length};this.code_mirror.setSelection(g,e)};a.prototype.create_output_area=function(){var d=$("<div/>").addClass("hbox output_area");d.append($("<div/>").addClass("prompt"));return d};a.prototype.append_output=function(f){this.collapse();this.set_input_prompt(f.prompt_number);var d=this.create_output_area();d.find("div.prompt").addClass("output_prompt").html("Out["+f.prompt_number+"]:");var e=$("<div/>").addClass("box_flex1 output_subarea");var g=$("<div/>").attr("id",this.cell_id);e.append(g);d.append(e);this.element.find("div.output").append(d);this.append_mime_type(f,g);if((f.latex!==undefined)||(f.html!==undefined)){this.typeset()}if($("#"+this.cell_id).html()!=""){this.expand()}};a.prototype.append_mime_type=function(e,d){if(e.html!==undefined){this.append_html(e.content,d)}else{if(e.latex!==undefined){this.append_latex(e.content,d)}else{if(e.svg!==undefined){this.append_svg(e.content,d)}else{if(e.png!==undefined){this.append_png(e.content,d)}else{if(e.jpeg!==undefined){this.append_jpeg(e.content,d)}else{if(e.javascript!==undefined){this.append_javascript(e.content,d)}else{if(e.text!==undefined){this.append_text(e.content,d)}}}}}}}};a.prototype.getCell=function(){return $("#"+this.cell_id)};a.prototype.load_library=function(d){$("body").append($("<script/>").attr("type","text/javascript").attr("src",d))};a.prototype.load_css=function(d){$("body").append($("<style/>").attr("type","text/css").attr("src",d))};a.prototype.append_html=function(e,d){d.append(e)};a.prototype.append_text=function(g,f,e){var d=$("<div/>").addClass("box_flex1 output_subarea output_text");if(e){d.addClass(e)}d.append($("<pre/>").html(g));f.append(d)};a.prototype.append_svg=function(e,f){var d=$("<div/>").addClass("box_flex1 output_subarea output_svg");d.append(e);f.append(d)};a.prototype.append_png=function(f,e){var d=$("<div/>").addClass("box_flex1 output_subarea output_png");d.append($("<img/>").attr("src","data:image/png;base64,"+f));e.append(d)};a.prototype.append_jpeg=function(e,f){var d=$("<div/>").addClass("box_flex1 output_subarea output_jpeg");d.append($("<img/>").attr("src","data:image/jpeg;base64,"+e));f.append(d)};a.prototype.append_javascript=function(d,e){c.runtime.execute(d,this)};a.prototype.append_latex=function(f,e){var d=$("<div/>").addClass("box_flex1 output_subarea output_latex");d.append(f);e.append(d)};a.prototype.clear_output=function(e,h,d){var k=this.element.find("div.output");if(e&&h&&d){k.html("");this.outputs=[];return}if(e){k.find("div.output_stdout").parent().remove()}if(h){k.find("div.output_stderr").parent().remove()}if(d){k.find("div.output_subarea").not("div.output_stderr").not("div.output_stdout").parent().remove()}for(var j=this.outputs.length-1;j>=0;j--){var g=this.outputs[j];var f=g.output_type;if(f=="display_data"&&d){this.outputs.splice(j,1)}else{if(f=="stream"){if(e&&g.stream=="stdout"){this.outputs.splice(j,1)}else{if(h&&g.stream=="stderr"){this.outputs.splice(j,1)}}}}}};a.prototype.clear_input=function(){this.code_mirror.setValue("")};a.prototype.collapse=function(){if(!this.collapsed){this.element.find("div.output").hide();this.collapsed=true}};a.prototype.expand=function(){if(this.collapsed){this.element.find("div.output").show();this.collapsed=false}};a.prototype.toggle_output=function(){if(this.collapsed){this.expand()}else{this.collapse()}};a.prototype.set_input_prompt=function(d){var e=d||"&nbsp;";this.input_prompt_number=e;this.element.find("div.input_prompt").html("In&nbsp;["+e+"]:")};a.prototype.get_code=function(){return this.code_mirror.getValue()};a.prototype.set_code=function(d){return this.code_mirror.setValue(d)};a.prototype.at_top=function(){var d=this.code_mirror.getCursor();if(d.line===0){return true}else{return false}};a.prototype.at_bottom=function(){var d=this.code_mirror.getCursor();if(d.line===(this.code_mirror.lineCount()-1)){return true}else{return false}};a.prototype.fromJSON=function(f){console.log("Import from JSON:",f);if(f.cell_type==="code"){if(f.input!==undefined){this.set_code(f.input)}if(f.prompt_number!==undefined){this.set_input_prompt(f.prompt_number)}else{this.set_input_prompt()}var d=f.outputs.length;for(var e=0;e<d;e++){this.append_output(f.outputs[e])}if(f.collapsed!==undefined){if(f.collapsed){this.collapse()}}}};a.prototype.toJSON=function(){var f={};f.input=this.get_code();f.cell_type="code";if(this.input_prompt_number!==" "){f.prompt_number=this.input_prompt_number}var g=[];var d=this.outputs.length;for(var e=0;e<d;e++){g[e]=this.outputs[e]}f.outputs=g;f.language="javascript";f.collapsed=this.collapsed;return f};c.CodeCell=a;return c}(skanti));